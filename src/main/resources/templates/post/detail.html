<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Post Detail</title>
</head>
<body>
<main layout:fragment="content">
    <table border="1">
        <tr>
            <td th:text="|작성자 : ${post.user.userName}|">default value</td>
            <td>
                <button id="scrapButton" onclick="toggleScrap()">
                    <i class="bi bi-bookmark"></i>
                </button>
                <button id="followButton" class="button" onclick="following()">팔로우</button>
            </td>
        </tr>
        <tr>
            <td th:text="|작성일시 : ${post.regDate}|">default value</td>
            <td th:text="|조회수 : ${post.viewCount}|">default value</td>
            <!--            <td th:text="|수정일시 : ${post.modDate}|">default value</td>-->
        </tr>
        <tr>
            <td th:text="|제목 : ${post.postTitle}|">default value</td>
        </tr>
        <tr>
            <td th:text="|내용 : ${post.postContent}|">default value</td>
        </tr>
        <tr>
            <td>
                <form th:action="@{/post/{postId}(postId=${post.postId})}" th:method="delete">
                    <button type="submit" class="button">삭제</button>
                </form>
            </td>
            <td>
                <button class="button">
                    <a th:href="'/post/edit/'+${post.postId}">수정</a>
                </button>
            </td>
            <td>
                <button class="button">
                    <a th:href="'/post/list/'+${post.boardId}">목록</a>
                </button>
            </td>

        </tr>
    </table>
    <div id="commentSection">
        <!-- 댓글 목록 -->
        <ul id="commentList">
            <!-- 댓글은 FETCH로 조회됩니다 -->
        </ul>

        <!-- 댓글 작성 폼 -->
        <div>
            <input type="text" id="commentContent" placeholder="댓글을 입력하세요">
            <button onclick="addComment()">댓글 추가</button>
        </div>
    </div>

    <script th:inline="javascript">
        // 댓글 목록 조회
        function loadComments() {
            fetch('/api/comment/[[${post.postId}]]', {

                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const commentList = document.getElementById('commentList');
                commentList.innerHTML = ''; // 기존 목록 초기화
                data.forEach(comment => {
                    const listItem = document.createElement('li');
                    listItem.id = `comment-${comment.commentId}`;
                    listItem.innerHTML = `
                        <span>${comment.user.userName}: ${comment.commentContent} 등록일시 : ${comment.regDate}</span>
                        <button onclick="editComment(${comment.commentId})">수정</button>
                        <button onclick="deleteComment(${comment.commentId})">삭제</button>
                    `;
                    commentList.appendChild(listItem);
                });
            })
            .catch(error => console.error('Error:', error));
        }

        function addComment() {
            const content = document.getElementById('commentContent').value;
            const postId = [[ ${post.postId} ]];

            fetch('/api/comment/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ commentContent: content, postId: postId})
            })
            .then(response => response.json())
            .then(data => {
                if(data.length === 0) {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>등록된 댓글이 없습니다.</span>`;
                    commentList.appendChild(listItem);
                } else {
                    const commentList = document.getElementById('commentList');
                    commentList.innerHTML = ''; // 기존 목록 초기화
                    data.forEach(comment => {
                        const listItem = document.createElement('li');
                        listItem.id = `comment-${comment.commentId}`;
                        listItem.innerHTML = `
                            <span>${comment.user.userName}: ${comment.commentContent} 등록일시 : ${comment.regDate}</span>
                            <button onclick="editComment(${comment.commentId})">수정</button>
                            <button onclick="deleteComment(${comment.commentId})">삭제</button>
                        `;
                        commentList.appendChild(listItem);
                    });
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // 댓글 수정
        function editComment(id) {
            const content = prompt("수정할 댓글 내용을 입력하세요:");
            if (content) {
                fetch(`/api/comment/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ commentContent: content })
                })
                .then(response => response.json())
                .then(updatedComment => {
                    const listItem = document.getElementById(`comment-${id}`);
                    const span = listItem.querySelector('span');
                    span.textContent = `${updatedComment.user.userName}: ${updatedComment.commentContent} 등록일시 : ${updatedComment.regDate}`;
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // 댓글 삭제
        function deleteComment(id) {
            fetch(`/api/comment/${id}`, {
                method: 'DELETE'
            })
            .then(() => {
                const listItem = document.getElementById(`comment-${id}`);
                listItem.remove();
            })
            .catch(error => console.error('Error:', error));
        }

        // 초기 로딩 시 댓글 목록 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            loadComments();
        });

        // 팔로우 체크
        function loadFollow() {
            fetch('/api/follow/[[ ${post.user.userId} ]]', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if(data === 1) {
                    document.getElementById("followButton").textContent = "팔로우 취소";
                } else {
                    document.getElementById("followButton").textContent = "팔로우";
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function following() {
            const userId = [[ ${post.user.userId} ]];

            fetch('/api/follow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ follow: userId })
            })
            .then(response => response.json())
            .then(data => {
                if(data === 0) {
                    document.getElementById("followButton").textContent = "팔로우";
                } else if(data === 1){
                    document.getElementById("followButton").textContent = "팔로우 취소";
                }
            })
            .catch(error => console.error('Error:', error));
        }

        //즐겨찾기 버튼 업데이트 함수
        function updateScrapBtn(isScrap) {
            if (isScrap) {
                $('#scrapButton i').removeClass('bi bi-bookmark').addClass('bi bi-bookmark-fill');
            } else {
                $('#scrapButton i').removeClass('bi bi-bookmark-fill').addClass('bi bi-bookmark');
            }
        }

        // 디테일 페이지 진입 시 실행
        $(document).ready(function() {
            var postId = '[[${postId}]]';

            // 즐겨찾기 상태
            $.ajax({
                url: `/bookmark/${postId}`,
                type: 'GET',
                success: function(response) {
                    updateScrapBtn(response.exist);
                },
                error: function(error) {
                    console.log('즐겨찾기 상태 확인 실패', error);
                }
            });
        });

        // 즐겨찾기 토글 함수
        function toggleScrap() {
            var postId = '[[${postId}]]';

            $.ajax({
                url: `/bookmark/${postId}`,
                type: 'POST',
                success: function(response) {
                    updateScrapBtn(response === 1);
                },
                error: function(error) {
                    console.log('즐겨찾기 토글 실패', error);
                }
            });
        }

    </script>
</main>
</body>
</html>